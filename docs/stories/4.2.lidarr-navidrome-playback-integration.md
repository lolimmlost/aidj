# Epic 4 Story 4.2: Lidarr-Navidrome Playback Integration

## Status
Draft

## Story
As a user,
I want songs requested via Lidarr to be playable once downloaded,
so that I can listen to music I've requested without waiting for separate workflows.

## Acceptance Criteria
1. Implement cross-service integration between Lidarr and Navidrome
2. Automatically detect when Lidarr-downloaded content becomes available in Navidrome
3. Enable playback of downloaded content through the existing audio player
4. Provide status indicators for download progress and availability
5. Handle cases where content is requested but not yet downloaded
6. Implement proper error handling for failed downloads or sync issues

## Tasks / Subtasks
- [ ] Analyze current Lidarr and Navidrome service architectures
  - [ ] Review shared media folder configuration
  - [ ] Understand Navidrome scanning triggers
  - [ ] Identify integration points
- [ ] Implement download status tracking
  - [ ] Add Lidarr download queue monitoring
  - [ ] Create status endpoint for download progress
  - [ ] Implement real-time status updates
- [ ] Create Navidrome availability checking
  - [ ] Add function to check if artist/album exists in Navidrome
  - [ ] Implement content matching between services
  - [ ] Handle metadata differences between Lidarr and Navidrome
- [ ] Update UI components for integrated workflow
  - [ ] Modify search results to show availability status
  - [ ] Add download progress indicators
  - [ ] Enable playback for downloaded content
  - [ ] Prevent queue addition for non-downloaded content
- [ ] Add unit and integration tests
  - [ ] Test cross-service data flow
  - [ ] Mock download scenarios
  - [ ] Test error conditions

## Dev Notes
### Previous Story Insights
From Epic 4 Story 4.1: Lidarr API integration provides search and request functionality. This story builds on that by connecting downloads to playback.

### Data Models
- Lidarr: Artist/Album metadata for requesting downloads
- Navidrome: Song objects with stream URLs for playback
- Integration: Map Lidarr requests to Navidrome availability

### API Specifications
- Lidarr: Monitor download queue via /api/v1/queue endpoint
- Navidrome: Search existing library for matching content
- Integration: Poll or webhook-based sync between services

### Component Specifications
- Update search UI to show Lidarr + Navidrome status
- Audio player remains unchanged, but queue population changes
- Add download status components

### File Locations
- Service integration: src/lib/services/lidarr-navidrome.ts
- API routes: src/routes/api/lidarr/status.ts, src/routes/api/navidrome/availability.ts
- UI components: Update existing search/library components
- Tests: src/lib/services/__tests__/lidarr-navidrome.test.ts

### Testing Requirements
- Unit tests for integration logic
- Integration tests for end-to-end download-to-playback flow
- Mock external service responses
- Test various download states and edge cases

### Technical Constraints
- Respect service timeouts (5s for local services)
- Handle async nature of downloads
- Maintain separation of concerns between services
- Ensure mobile performance with status polling

## Testing
- Unit tests for service integration functions
- Integration tests for download status tracking
- E2E tests for complete request-to-playback workflow
- Error handling and edge case testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial draft | Developer |