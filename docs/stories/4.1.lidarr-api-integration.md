# Epic 4 Story 4.1: Lidarr API Integration

## Status
Draft

## Story
As a developer,
I want to implement API integration with Lidarr,
so that the application can search for and request music downloads.

## Acceptance Criteria
1. Create service layer using TanStack Start's API routes for making API calls to Lidarr
2. Implement API key authentication with encrypted session storage
3. Handle search functionality with query parameters and standardized error handling patterns
4. Implement album/artist lookup capabilities with mobile-specific performance optimizations
5. Handle API responses with proper parsing and service connection timeout specifications (5s for local services)
6. Implement error handling for API failures using standardized patterns
7. Implement artist addition to Lidarr library with duplicate prevention
8. Provide availability checking to prevent duplicate artist additions

## Tasks / Subtasks
- [ ] Create Lidarr service layer (src/lib/services/lidarr.ts)
  - [ ] Implement authentication with API key
  - [ ] Add search functionality for albums/artists
  - [ ] Handle API responses and parsing
  - [ ] Implement error handling
- [ ] Create API routes for Lidarr proxying (src/routes/api/lidarr/)
  - [ ] Set up route structure similar to Navidrome
  - [ ] Implement search endpoint
  - [ ] Add timeout handling (5s)
- [ ] Add unit tests for Lidarr service
- [ ] Update configuration for Lidarr URL and API key

## Dev Notes
### Previous Story Insights
From Epic 3 Story 3.8: Search reliability improvements used similar patterns for Navidrome API integration, including token management, error handling, and prioritization logic. This can inform Lidarr implementation.

### Data Models
No specific data models defined in architecture for Lidarr, but follow patterns from Navidrome service. Expected data structures for search results include album/artist metadata.

### API Specifications
- Base URL: Configurable (default: http://localhost:8686)
- Authentication: API key-based
- Key endpoints: Search for albums/artists, request downloads
- Timeout: 5s for local services [Source: docs/prd-epic-4.md]

### Component Specifications
No UI components for this story - backend/API only.

### File Locations
- Service: src/lib/services/lidarr.ts
- API routes: src/routes/api/lidarr/[...path].ts
- Tests: src/lib/services/__tests__/lidarr.test.ts

### Testing Requirements
- Unit tests for service layer using Vitest
- Mock API responses for testing
- Test error handling scenarios
- Follow testing strategy from docs/architecture.md#testing-strategy

### Technical Constraints
- Use TanStack Start API routes
- Encrypted session storage for API key
- Standardized error handling patterns
- Mobile-specific performance optimizations

## Testing
- Unit tests for Lidarr service functions
- Integration tests for API routes
- Error handling test cases
- Mock external API for CI

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial draft | Scrum Master |